name: Auto Update Dependencies

on:
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  update-npm-dependencies:
    name: Update NPM Dependencies
    runs-on: ubuntu-latest
    strategy:
      matrix:
        portal: [saas-admin-portal, tenant-admin-portal, customer-portal, showcase-pages]
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Update dependencies
        working-directory: ${{ matrix.portal }}
        run: |
          npm update
          npm audit fix || true
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update ${{ matrix.portal }} dependencies"
          title: "Auto-update: ${{ matrix.portal }} dependencies"
          body: |
            Automated dependency updates for ${{ matrix.portal }}
            
            - Updated npm packages to latest compatible versions
            - Fixed security vulnerabilities where possible
            
            Please review and test before merging.
          branch: auto-update-${{ matrix.portal }}-deps
          delete-branch: true

  docker-security-scan:
    name: Scan Docker Images for Vulnerabilities
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'docker/'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
