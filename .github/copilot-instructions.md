## ERPNext SaaS Platform — AI guide (concise)

- **Stack map**: Docker Compose (`docker/docker-compose.yml`) brings up MariaDB + three Redis roles + ERPNext (v16) workers/socketio/backend, Nginx, 4 Next.js 14 portals, and the .NET 8 ABP API (`abp-backend`, port 5000). All services live on the `erpnext-network` bridge.
- **Data model**: Four SQL schemas in `database-schemas/01-04_*.sql` (saas_admin, tenant_admin, subscriptions_billing, container_management). Tenant DBs are per-tenant (`tenant_{id}`) with users `user_{id}`. ERPNext sites are `{tenant}.erp.local`.
- **Provisioning**: Always onboard via `scripts/create_tenant.sh <tenant_id> "Org" admin@mail [starter|professional|enterprise]`. It creates DB/user, applies `02_tenant_admin_schema.sql`, runs `bench new-site` in `erpnext-backend`, and registers the tenant + subscription rows in `saas_admin` (status active). Tenant IDs must match `^[a-z][a-z0-9_-]{2,29}$`.
- **Build/run essentials**:
  - Full stack: `docker compose -f docker/docker-compose.yml up -d` (uses env from `configs/common.env`; ensure `DB_ROOT_PASSWORD` set).
  - Build all images: `scripts/build_all.sh` (targets base, module Dockerfiles under `docker/modules/`, and all portals).
  - ABP API dev: `dotnet restore && dotnet run --project src/AbpSaasPlatform.HttpApi.Host` (net8, MySQL via `ConnectionStrings__Default`). Health checks at `/health` and `/health/ready`.
  - Frontend dev inside each portal folder (`saas-admin-portal`, `tenant-admin-portal`, `customer-portal`, `showcase-pages`): `npm install` once, then `npm run dev|build|lint|type-check` (ports 3000-3003). Tailwind + shadcn/ui; use `cn()` in `src/lib/utils.ts` for class merging.
- **ABP patterns**:
  - EF Core MySQL context: `AbpSaasPlatformDbContext` exposes `Tenants`, `TenantModules`, `Subscriptions` with Fluent configurations under `EntityFrameworkCore/Configurations` (table names lowercase, string lengths enforced, money precision set on `MonthlyPrice`).
  - Application services live in `AbpSaasPlatform.Application` (e.g., `TenantAppService` CRUD); contracts + DTOs in `.Application.Contracts`. No custom controllers—ABP generates REST endpoints for app services; CORS origins come from `App:CorsOrigins` in `appsettings.json`.
  - Program bootstrap uses Serilog (console + `Logs/app-*.txt`), CORS policy named `CorsPolicy`, and JWT bearer auth (authority from `AuthServer:*`).
- **UI conventions**:
  - Next.js App Router with colocated components under `src/components` (dashboard cards, charts, tables). Data formatting helpers in `src/lib/utils.ts` (currency/date/number, `cn`). Charts use Recharts; forms use `react-hook-form` + Zod; server state via `@tanstack/react-query` where applicable.
  - Layout pattern: header + sidebar shells, dashboard pages follow the card/grid composition shown in `saas-admin-portal/src/app/(dashboard)/dashboard/page.tsx`.
- **Images & modules**: Base ERPNext image is built from `docker/modules/Dockerfile.base`; module-specific Dockerfiles (`Dockerfile.accounting`, `...crm`, etc.) layer custom apps from `apps/`. `build_all.sh` tags images as `${DOCKER_REGISTRY:-erpnext-saas}/{module}:${VERSION:-v16}`.
- **Environment & secrets**: `configs/common.env` is the single source; never commit real creds. Nginx pulls TLS from `/etc/letsencrypt`. ABP `appsettings.json` currently uses placeholder connection strings and CORS hosts—override via env vars in Compose.
- **Diagnostics & admin**:
  - Check containers: `docker compose -f docker/docker-compose.yml ps` and `docker logs <service>`; MariaDB shell: `docker exec -it erpnext-mariadb mysql -u root -p$DB_ROOT_PASSWORD`.
  - ERPNext health: backend on 8000, socketio on 9000; ensure ports 3000-3003/5000/8000/3306/6379 are free before bringing up.
- **Data flow expectations**: Portals → ABP API (JWT) for SaaS metadata, ABP/ERPNext responsible for provisioning by shelling out to `create_tenant.sh`; keep tenant isolation strictly database-per-tenant and avoid bypassing the script.
